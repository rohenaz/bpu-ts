var t=require("@ts-bitcoin/core");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var e=/*#__PURE__*/r(require("bitcoind-rpc")),n=function(r){var e=r.tx.r;return new Promise(function(n,o){if(e){var s=t.Tx.fromHex(e),u=s.txIns?i(r,"in",s.txIns):[],f=s.txOuts?i(r,"out",s.txOuts):[];n({tx:{h:s.id()},in:u,out:f,lock:s.nLockTime})}else o(new Error("No transaction"))})},i=function(r,e,n){var i=[];return r.transform||(r.transform=function(t){return t}),n.forEach(function(n,o){if(n.script){var s={i:o,tape:[]},u=0,f=0,a=[];if(n.script.chunks.forEach(function(e,n){if(e.buf){var i,o=e.buf.toString("base64"),c=e.buf.toString("utf8"),p=!1;if(r.split&&Array.isArray(r.split)&&r.split.forEach(function(t){(t.token&&t.token.s&&t.token.s===c||t.token&&t.token.b&&t.token.b===o)&&(i=t.include,p=!0)}),p&&r.transform)if("l"===i){var l=r.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:f++},e);a.push(l),s.tape.push({cell:a,i:u++}),a=[],f=0}else if("r"===i){s.tape.push({cell:a,i:u++});var h=r.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:f++},e);a=[h],f=1}else if("c"===i){s.tape.push({cell:a,i:u++});var v=r.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:0},e);s.tape.push({cell:[v],i:u++}),a=[],f=0}else s.tape.push({cell:a,i:u++}),a=[],f=0;else if(r.transform){var m=r.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:f++},e);a.push(m)}}else if(void 0!==e.opCodeNum){var b,S=e.opCodeNum,x=t.OpCode[S].toString(),I=!1;if(r.split&&Array.isArray(r.split)&&r.split.forEach(function(t){(t.token&&t.token.op&&t.token.op===S||t.token&&t.token.ops&&t.token.ops===x)&&(b=t.include,I=!0)}),I&&r.transform)if("l"===b){var g=r.transform({op:S,ops:x,ii:n,i:f++},e);a.push(g),s.tape.push({cell:a,i:u++}),a=[],f=0}else if("r"===b){s.tape.push({cell:a,i:u++});var d=r.transform({op:S,ops:x,ii:n,i:f++},e);a=[d],f=1}else if("c"===b){s.tape.push({cell:a,i:u++});var O=r.transform({op:S,ops:x,ii:n,i:f++},e);s.tape.push({cell:[O],i:u++}),a=[],f=0}else s.tape.push({cell:a,i:u++}),a=[],f=0;else if(r.transform){var P=r.transform({op:S,ops:x,ii:n,i:f++},e);a.push(P)}}else r.transform&&a.push(r.transform({op:e,ii:n,i:f++},e))}),a.length>0&&s.tape.push({cell:a,i:u++}),"in"===e){var c,p={h:null==(c=n.txHashBuf)?void 0:c.toString("hex"),i:n.scriptVi.toNumber()},l=t.Address.fromTxInScript(n.script).toString();l&&l.length>0&&(p.a=l),s.e=p,s.seq=n.nSequence}else if("out"===e){var h={v:n.valueBn.toNumber(),i:o},v=t.Address.fromTxOutScript(n.script).toString();v&&v.length>0&&(h.a=v),s.e=h}i.push(s)}}),i};exports.parse=function(t,r){try{var i,o=function(t){if(i)return t;throw new Error("Invalid Tx")},s=function(){if(t.tx)return t.tx.h?Promise.resolve(function(t,r){r||(console.log("split from hash without config"),r={protocol:"http",user:process.env.BITCOIN_USERNAME?process.env.BITCOIN_USERNAME:"root",pass:process.env.BITCOIN_PASSWORD?process.env.BITCOIN_PASSWORD:"bitcoin",host:process.env.BITCOIN_IP?process.env.BITCOIN_IP:"127.0.0.1",port:process.env.BITCOIN_PORT?process.env.BITCOIN_PORT:"8332"});var i=new e.default(r);return new Promise(function(r,e){var o;null!=(o=t.tx)&&o.h&&i.getRawTransaction(t.tx.h,function(i,o){try{var s=function(){if(i)e(i);else{var s=function(){if(t.tx)return t.tx.r=o.result,Promise.resolve(n(t)).then(function(t){r(t)});e(new Error("Failed to get raw tx from RPC endpoint"))}();if(s&&s.then)return s.then(function(){})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}})})}(t,r)).then(function(t){return i=1,t}):function(){if(t.tx.r)return Promise.resolve(n(t)).then(function(t){return i=1,t})}()}();return Promise.resolve(s&&s.then?s.then(o):o(s))}catch(t){return Promise.reject(t)}};
//# sourceMappingURL=index.js.map
