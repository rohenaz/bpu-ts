import{Tx as t,OpCode as r,Address as e}from"@ts-bitcoin/core";import n from"bitcoind-rpc";var o=function(r){var e=r.tx.r;return new Promise(function(n,o){if(e){var s=t.fromHex(e),u=s.txIns?i(r,"in",s.txIns):[],f=s.txOuts?i(r,"out",s.txOuts):[];n({tx:{h:s.id()},in:u,out:f,lock:s.nLockTime})}else o(new Error("No transaction"))})},i=function(t,n,o){var i=[];return t.transform||(t.transform=function(t){return t}),o.forEach(function(o,s){if(o.script){var u={i:s,tape:[]},f=0,a=0,c=[];if(o.script.chunks.forEach(function(e,n){if(e.buf){var o,i=e.buf.toString("base64"),s=e.buf.toString("utf8"),p=!1;if(t.split&&Array.isArray(t.split)&&t.split.forEach(function(t){(t.token&&t.token.s&&t.token.s===s||t.token&&t.token.b&&t.token.b===i)&&(o=t.include,p=!0)}),p&&t.transform)if("l"===o){var l=t.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:a++},e);c.push(l),u.tape.push({cell:c,i:f++}),c=[],a=0}else if("r"===o){u.tape.push({cell:c,i:f++});var h=t.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:a++},e);c=[h],a=1}else if("c"===o){u.tape.push({cell:c,i:f++});var v=t.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:0},e);u.tape.push({cell:[v],i:f++}),c=[],a=0}else u.tape.push({cell:c,i:f++}),c=[],a=0;else if(t.transform){var m=t.transform({b:e.buf.toString("base64"),s:e.buf.toString("utf8"),ii:n,i:a++},e);c.push(m)}}else if(void 0!==e.opCodeNum){var b,S=e.opCodeNum,I=r[S].toString(),g=!1;if(t.split&&Array.isArray(t.split)&&t.split.forEach(function(t){(t.token&&t.token.op&&t.token.op===S||t.token&&t.token.ops&&t.token.ops===I)&&(b=t.include,g=!0)}),g&&t.transform)if("l"===b){var x=t.transform({op:S,ops:I,ii:n,i:a++},e);c.push(x),u.tape.push({cell:c,i:f++}),c=[],a=0}else if("r"===b){u.tape.push({cell:c,i:f++});var P=t.transform({op:S,ops:I,ii:n,i:a++},e);c=[P],a=1}else if("c"===b){u.tape.push({cell:c,i:f++});var k=t.transform({op:S,ops:I,ii:n,i:a++},e);u.tape.push({cell:[k],i:f++}),c=[],a=0}else u.tape.push({cell:c,i:f++}),c=[],a=0;else if(t.transform){var N=t.transform({op:S,ops:I,ii:n,i:a++},e);c.push(N)}}else t.transform&&c.push(t.transform({op:e,ii:n,i:a++},e))}),c.length>0&&u.tape.push({cell:c,i:f++}),"in"===n){var p,l={h:null==(p=o.txHashBuf)?void 0:p.toString("hex"),i:o.scriptVi.toNumber()},h=e.fromTxInScript(o.script).toString();h&&h.length>0&&(l.a=h),u.e=l,u.seq=o.nSequence}else if("out"===n){var v={v:o.valueBn.toNumber(),i:s},m=e.fromTxOutScript(o.script).toString();m&&m.length>0&&(v.a=m),u.e=v}i.push(u)}}),i},s=function(t,r){try{var e,i=function(t){if(e)return t;throw new Error("Invalid Tx")},s=function(){if(t.tx)return t.tx.h?Promise.resolve(function(t,r){r||(console.log("split from hash without config"),r={protocol:"http",user:process.env.BITCOIN_USERNAME?process.env.BITCOIN_USERNAME:"root",pass:process.env.BITCOIN_PASSWORD?process.env.BITCOIN_PASSWORD:"bitcoin",host:process.env.BITCOIN_IP?process.env.BITCOIN_IP:"127.0.0.1",port:process.env.BITCOIN_PORT?process.env.BITCOIN_PORT:"8332"});var e=new n(r);return new Promise(function(r,n){var i;null!=(i=t.tx)&&i.h&&e.getRawTransaction(t.tx.h,function(e,i){try{var s=function(){if(e)n(e);else{var s=function(){if(t.tx)return t.tx.r=i.result,Promise.resolve(o(t)).then(function(t){r(t)});n(new Error("Failed to get raw tx from RPC endpoint"))}();if(s&&s.then)return s.then(function(){})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}})})}(t,r)).then(function(t){return e=1,t}):function(){if(t.tx.r)return Promise.resolve(o(t)).then(function(t){return e=1,t})}()}();return Promise.resolve(s&&s.then?s.then(i):i(s))}catch(t){return Promise.reject(t)}};export{s as parse};
//# sourceMappingURL=index.module.js.map
