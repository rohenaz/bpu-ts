!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@ts-bitcoin/core"),require("bitcoind-rpc")):"function"==typeof define&&define.amd?define(["exports","@ts-bitcoin/core","bitcoind-rpc"],e):e((t||self).bpuTs={},t.core,t.bitcoindRpc)}(this,function(t,e,r){function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=/*#__PURE__*/n(r),i=function(t){var r=t.tx.r;return new Promise(function(n,o){if(r){var i=e.Tx.fromHex(r),f=i.txIns?s(t,"in",i.txIns):[],u=i.txOuts?s(t,"out",i.txOuts):[];n({tx:{h:i.id()},in:f,out:u,lock:i.nLockTime})}else o(new Error("No transaction"))})},s=function(t,r,n){var o=[];return t.transform||(t.transform=function(t){return t}),n.forEach(function(n,i){if(n.script){var s={i:i,tape:[]},f=0,u=0,c=[];if(n.script.chunks.forEach(function(r,n){if(r.buf){var o,i=r.buf.toString("base64"),a=r.buf.toString("utf8"),p=!1;if(t.split&&Array.isArray(t.split)&&t.split.forEach(function(t){(t.token&&t.token.s&&t.token.s===a||t.token&&t.token.b&&t.token.b===i)&&(o=t.include,p=!0)}),p&&t.transform)if("l"===o){var l=t.transform({b:r.buf.toString("base64"),s:r.buf.toString("utf8"),ii:n,i:u++},r);c.push(l),s.tape.push({cell:c,i:f++}),c=[],u=0}else if("r"===o){s.tape.push({cell:c,i:f++});var h=t.transform({b:r.buf.toString("base64"),s:r.buf.toString("utf8"),ii:n,i:u++},r);c=[h],u=1}else if("c"===o){s.tape.push({cell:c,i:f++});var v=t.transform({b:r.buf.toString("base64"),s:r.buf.toString("utf8"),ii:n,i:0},r);s.tape.push({cell:[v],i:f++}),c=[],u=0}else s.tape.push({cell:c,i:f++}),c=[],u=0;else if(t.transform){var m=t.transform({b:r.buf.toString("base64"),s:r.buf.toString("utf8"),ii:n,i:u++},r);c.push(m)}}else if(void 0!==r.opCodeNum){var b,d=r.opCodeNum,x=e.OpCode[d].toString(),g=!1;if(t.split&&Array.isArray(t.split)&&t.split.forEach(function(t){(t.token&&t.token.op&&t.token.op===d||t.token&&t.token.ops&&t.token.ops===x)&&(b=t.include,g=!0)}),g&&t.transform)if("l"===b){var S=t.transform({op:d,ops:x,ii:n,i:u++},r);c.push(S),s.tape.push({cell:c,i:f++}),c=[],u=0}else if("r"===b){s.tape.push({cell:c,i:f++});var I=t.transform({op:d,ops:x,ii:n,i:u++},r);c=[I],u=1}else if("c"===b){s.tape.push({cell:c,i:f++});var T=t.transform({op:d,ops:x,ii:n,i:u++},r);s.tape.push({cell:[T],i:f++}),c=[],u=0}else s.tape.push({cell:c,i:f++}),c=[],u=0;else if(t.transform){var O=t.transform({op:d,ops:x,ii:n,i:u++},r);c.push(O)}}else t.transform&&c.push(t.transform({op:r,ii:n,i:u++},r))}),c.length>0&&s.tape.push({cell:c,i:f++}),"in"===r){var a,p={h:null==(a=n.txHashBuf)?void 0:a.toString("hex"),i:n.scriptVi.toNumber()},l=e.Address.fromTxInScript(n.script).toString();l&&l.length>0&&(p.a=l),s.e=p,s.seq=n.nSequence}else if("out"===r){var h={v:n.valueBn.toNumber(),i:i},v=e.Address.fromTxOutScript(n.script).toString();v&&v.length>0&&(h.a=v),s.e=h}o.push(s)}}),o};t.parse=function(t,e){try{var r,n=function(t){if(r)return t;throw new Error("Invalid Tx")},s=function(){if(t.tx)return t.tx.h?Promise.resolve(function(t,e){e||(console.log("split from hash without config"),e={protocol:"http",user:process.env.BITCOIN_USERNAME?process.env.BITCOIN_USERNAME:"root",pass:process.env.BITCOIN_PASSWORD?process.env.BITCOIN_PASSWORD:"bitcoin",host:process.env.BITCOIN_IP?process.env.BITCOIN_IP:"127.0.0.1",port:process.env.BITCOIN_PORT?process.env.BITCOIN_PORT:"8332"});var r=new o.default(e);return new Promise(function(e,n){var o;null!=(o=t.tx)&&o.h&&r.getRawTransaction(t.tx.h,function(r,o){try{var s=function(){if(r)n(r);else{var s=function(){if(t.tx)return t.tx.r=o.result,Promise.resolve(i(t)).then(function(t){e(t)});n(new Error("Failed to get raw tx from RPC endpoint"))}();if(s&&s.then)return s.then(function(){})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}})})}(t,e)).then(function(t){return r=1,t}):function(){if(t.tx.r)return Promise.resolve(i(t)).then(function(t){return r=1,t})}()}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(t){return Promise.reject(t)}}});
//# sourceMappingURL=index.umd.js.map
